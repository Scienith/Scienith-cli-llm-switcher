#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

source "$PROJECT_ROOT/src/providers.sh"
source "$PROJECT_ROOT/src/config.sh"

VERSION="0.1.0a1"

function show_usage() {
    cat << EOF
LLM Switch v${VERSION} - CLI Tool for Switching Between LLM Providers

Usage: llm-switch [COMMAND] [OPTIONS]

Commands:
  <provider>     Switch to specified provider (qwen, zhipu, kimi, deepseek, claude, openai, groq)
  status         Show current active provider
  list           List all available providers
  models         Show all available models
  models <name>  Show models for specific provider
  config         Configure API keys for providers
  config <name>  Configure specific provider
  help           Show this help message
  version        Show version information

Shortcuts:
  q, Q     Switch to Qwen
  z, Z     Switch to Zhipu
  k, K     Switch to Kimi K2
  d, D     Switch to DeepSeek
  c, C     Switch to Claude
  o, O     Switch to OpenAI
  g, G     Switch to Groq

Examples:
  llm-switch deepseek        # Switch to DeepSeek
  llm-switch d               # Switch to DeepSeek (shortcut)
  llm-switch status          # Show current provider
  llm-switch models          # Show all available models
  llm-switch models deepseek # Show DeepSeek models
  llm-switch config deepseek # Configure DeepSeek API key
  
After switching, use 'claude' or 'qwen' command to interact with the selected LLM.

Configuration stored in: ./config/providers.ini
EOF
}

function show_version() {
    echo "LLM Switch v${VERSION}"
    echo "GitHub: https://github.com/Scienith/Scienith-cli-llm-switcher"
}

function show_status() {
    show_current_status
}

function switch_provider_command() {
    local provider="$1"
    
    # Use the new switch_provider function from providers.sh
    switch_provider "$provider"
}

function main() {
    if [[ $# -eq 0 ]]; then
        show_usage
        exit 0
    fi
    
    case "$1" in
        help|--help|-h)
            show_usage
            ;;
        version|--version|-v)
            show_version
            ;;
        status)
            show_status
            ;;
        list)
            list_providers
            ;;
        models)
            if [[ -n "$2" ]]; then
                show_provider_models "$2"
            else
                show_all_models
            fi
            ;;
        config)
            if [[ -n "$2" ]]; then
                configure_provider "$2"
            else
                configure_all
            fi
            ;;
        *)
            switch_provider_command "$1"
            ;;
    esac
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi